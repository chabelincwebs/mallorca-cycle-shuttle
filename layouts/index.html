{{ define "main" }}

  {{/* ========================================
       HERO SECTION - Full-width with gradient overlay
       ======================================== */}}
  <section class="homepage-hero">
    <div class="homepage-hero-overlay"></div>
    <div class="homepage-hero-image">
      <img src="/img/hero-main.webp" alt="Cycling in Mallorca Tramuntana Mountains">
    </div>

    <div class="homepage-hero-content">
      <h1 class="homepage-hero-title">{{ .Params.hero_title }}</h1>
      <p class="homepage-hero-subtitle">{{ .Params.hero_subtitle }}</p>

      <div class="homepage-hero-ctas">
        {{ range .Params.hero_ctas }}
          <a href="{{ .url }}" class="homepage-cta-btn {{ .style }}">
            {{ .text }}
          </a>
        {{ end }}
      </div>
    </div>
  </section>

  {{/* ========================================
       SERVICE CARDS SECTION - 3 columns
       ======================================== */}}
  {{ with .Params.services }}
  <section class="homepage-services">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.services_title }}</h2>
      <div class="homepage-services-grid">
        {{ range . }}
        <div class="homepage-service-card fade-in-on-scroll">
          <div class="homepage-service-icon">
            <img src="{{ .icon }}" alt="{{ .title }}">
          </div>
          <h3>{{ .title }}</h3>
          <p>{{ .description }}</p>
          <a href="{{ .link }}" class="homepage-service-link">Learn More →</a>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       ALTERNATING CONTENT BLOCKS
       ======================================== */}}
  {{ with .Params.content_blocks }}
  <section class="homepage-content-blocks">
    <div class="container">
      {{ range $index, $block := . }}
        <div class="homepage-content-block {{ if eq (mod $index 2) 0 }}image-right{{ else }}image-left{{ end }} fade-in-on-scroll">
          <div class="homepage-content-block-text">
            <h2>{{ $block.title }}</h2>
            <p>{{ $block.text }}</p>
            {{ if $block.cta }}
              <a href="{{ $block.cta.url }}" class="homepage-text-cta">{{ $block.cta.text }} →</a>
            {{ end }}
          </div>
          <div class="homepage-content-block-image">
            <img src="{{ $block.image }}" alt="{{ $block.title }}">
          </div>
        </div>
      {{ end }}
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       STATS SECTION - Counter animation
       ======================================== */}}
  {{ with .Params.stats }}
  <section class="homepage-stats">
    <div class="container">
      <div class="homepage-stats-grid">
        {{ range . }}
        <div class="homepage-stat-item fade-in-on-scroll">
          <div class="homepage-stat-number" data-target="{{ .number }}">0</div>
          <div class="homepage-stat-label">{{ .label }}</div>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       FEATURED ROUTES SECTION
       ======================================== */}}
  {{ with .Params.featured_routes }}
  <section class="homepage-routes">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.routes_title }}</h2>
      <div class="homepage-routes-grid">
        {{ range . }}
        <a href="{{ .link }}" class="homepage-route-card fade-in-on-scroll">
          <div class="homepage-route-image">
            <img src="{{ .image }}" alt="{{ .title }}">
            {{ if .badge }}
              <span class="homepage-route-badge">{{ .badge }}</span>
            {{ end }}
          </div>
          <div class="homepage-route-content">
            <h3>{{ .title }}</h3>
            <p class="homepage-route-meta">{{ .distance }} • {{ .elevation }}</p>
          </div>
        </a>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       TESTIMONIALS SECTION
       ======================================== */}}
  {{ with .Params.testimonials }}
  <section class="homepage-testimonials">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.testimonials_title }}</h2>
      <div class="testimonials-carousel-wrapper">
        <button class="carousel-btn carousel-btn-prev" aria-label="Previous testimonials">‹</button>
        <div class="homepage-testimonials-carousel">
          <div class="testimonials-track">
            {{ range . }}
            <div class="homepage-testimonial-card">
              <div class="homepage-testimonial-stars">★★★★★</div>
              <p class="homepage-testimonial-text">"{{ .quote }}"</p>
              <div class="homepage-testimonial-author">
                <strong>{{ .name }}</strong>
                {{ if .location }}<span> • {{ .location }}</span>{{ end }}
              </div>
            </div>
            {{ end }}
          </div>
        </div>
        <button class="carousel-btn carousel-btn-next" aria-label="Next testimonials">›</button>
      </div>
      <div class="carousel-dots"></div>
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       FAQ ACCORDION
       ======================================== */}}
  {{ with .Params.faq }}
  <section class="homepage-faq">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.faq_title }}</h2>
      <div class="homepage-faq-grid">
        {{ range . }}
        <details class="faq-item">
          <summary>{{ .question }}</summary>
          <div class="answer">{{ .answer | markdownify }}</div>
        </details>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ========================================
       FINAL CTA BANNER
       ======================================== */}}
  {{ with .Params.final_cta }}
  <section class="homepage-final-cta">
    <div class="container">
      <div class="homepage-final-cta-content">
        <h2>{{ .title }}</h2>
        <p>{{ .subtitle }}</p>
        <a href="{{ .button_url }}" class="homepage-cta-btn primary">{{ .button_text }}</a>
      </div>
    </div>
  </section>
  {{ end }}

  {{/* Scroll animation script */}}
  <script>
    // Fade-in on scroll animation
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, observerOptions);

    document.querySelectorAll('.fade-in-on-scroll').forEach(el => {
      observer.observe(el);
    });

    // Stats counter animation
    const counters = document.querySelectorAll('.homepage-stat-number');
    const counterObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !entry.target.classList.contains('counted')) {
          const target = parseFloat(entry.target.dataset.target);
          const hasDecimal = entry.target.dataset.target.includes('.');
          const duration = 2000;
          const step = target / (duration / 16);
          let current = 0;

          const timer = setInterval(() => {
            current += step;
            if (current >= target) {
              entry.target.textContent = hasDecimal ? target.toFixed(1) : target.toLocaleString();
              clearInterval(timer);
              entry.target.classList.add('counted');
            } else {
              entry.target.textContent = hasDecimal ? current.toFixed(1) : Math.floor(current).toLocaleString();
            }
          }, 16);
        }
      });
    }, { threshold: 0.5 });

    counters.forEach(counter => counterObserver.observe(counter));
  </script>

  <script>
    // Testimonials Carousel
    document.addEventListener('DOMContentLoaded', function() {
      const track = document.querySelector('.testimonials-track');
      const prevBtn = document.querySelector('.carousel-btn-prev');
      const nextBtn = document.querySelector('.carousel-btn-next');
      const dotsContainer = document.querySelector('.carousel-dots');

      if (!track || !prevBtn || !nextBtn || !dotsContainer) return;

      const cards = Array.from(track.children);
      const totalCards = cards.length;
      const cardsPerView = 3;
      const totalPages = Math.ceil(totalCards / cardsPerView);
      let currentPage = 0;

      // Create dots
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement('button');
        dot.classList.add('carousel-dot');
        dot.setAttribute('aria-label', `Go to testimonials page ${i + 1}`);
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => goToPage(i));
        dotsContainer.appendChild(dot);
      }

      const dots = Array.from(dotsContainer.children);

      function updateCarousel() {
        const cardWidth = cards[0].offsetWidth;
        const gap = 32; // 2rem in pixels
        const offset = currentPage * (cardsPerView * (cardWidth + gap));
        track.style.transform = `translateX(-${offset}px)`;

        // Update dots
        dots.forEach((dot, index) => {
          dot.classList.toggle('active', index === currentPage);
        });

        // Update button states
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;
        prevBtn.style.opacity = currentPage === 0 ? '0.5' : '1';
        nextBtn.style.opacity = currentPage === totalPages - 1 ? '0.5' : '1';
      }

      function goToPage(page) {
        currentPage = page;
        updateCarousel();
      }

      function nextPage() {
        if (currentPage < totalPages - 1) {
          currentPage++;
          updateCarousel();
        }
      }

      function prevPage() {
        if (currentPage > 0) {
          currentPage--;
          updateCarousel();
        }
      }

      prevBtn.addEventListener('click', prevPage);
      nextBtn.addEventListener('click', nextPage);

      // Handle window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          updateCarousel();
        }, 250);
      });

      // Initial update
      updateCarousel();
    });
  </script>

{{ end }}
