{{ define "title" }}{{ .Title }}{{ end }}

{{ define "main" }}
{{/* Check if this is a language home page (e.g., /de/, /es/) */}}
{{ $isLangHome := false }}
{{ if .File }}
  {{ if and (eq .Kind "section") (or (eq .File.Dir "en/") (eq .File.Dir "de/") (eq .File.Dir "es/") (eq .File.Dir "it/") (eq .File.Dir "fr/") (eq .File.Dir "ca/")) }}
    {{ $isLangHome = true }}
  {{ end }}
{{ end }}
{{ if $isLangHome }}
  {{/* This is a language home page - use the NEW homepage template */}}

  {{/* ======================================== HERO SECTION */}}
  <section class="homepage-hero">
    <div class="homepage-hero-overlay"></div>
    <div class="homepage-hero-image">
      <img src="{{ .Params.hero_image | default "/img/hero-main.webp" }}" alt="{{ .Params.hero_title }}">
    </div>
    <div class="homepage-hero-content">
      <h1 class="homepage-hero-title">{{ .Params.hero_title }}</h1>
      <p class="homepage-hero-subtitle">{{ .Params.hero_subtitle }}</p>
      <div class="homepage-hero-ctas">
        {{ range .Params.hero_ctas }}
          <a href="{{ .url }}" class="homepage-cta-btn {{ .style }}">{{ .text }}</a>
        {{ end }}
      </div>
    </div>
  </section>

  {{/* ======================================== SERVICE CARDS */}}
  {{ with .Params.services }}
  <section class="homepage-services">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.services_title }}</h2>
      <div class="homepage-services-grid">
        {{ range . }}
        <div class="homepage-service-card fade-in-on-scroll">
          <div class="homepage-service-icon"><img src="{{ .icon }}" alt="{{ .title }}" loading="lazy"></div>
          <h3>{{ .title }}</h3>
          <p>{{ .description }}</p>
          <a href="{{ .link }}" class="homepage-service-link">Learn More →</a>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ======================================== CONTENT BLOCKS */}}
  {{ with .Params.content_blocks }}
  <section class="homepage-content-blocks">
    <div class="container">
      {{ range $index, $block := . }}
        <div class="homepage-content-block {{ if eq (mod $index 2) 0 }}image-right{{ else }}image-left{{ end }} fade-in-on-scroll">
          <div class="homepage-content-block-text">
            <h2>{{ $block.title }}</h2>
            <p>{{ $block.text }}</p>
            {{ if $block.cta }}<a href="{{ $block.cta.url }}" class="homepage-text-cta">{{ $block.cta.text }} →</a>{{ end }}
          </div>
          <div class="homepage-content-block-image"><img src="{{ $block.image }}" alt="{{ $block.title }}" loading="lazy"></div>
        </div>
      {{ end }}
    </div>
  </section>
  {{ end }}

  {{/* ======================================== STATS SECTION */}}
  {{ with .Params.stats }}
  <section class="homepage-stats">
    <div class="container">
      <div class="homepage-stats-grid">
        {{ range . }}
        <div class="homepage-stat-item fade-in-on-scroll">
          <div class="homepage-stat-number" data-target="{{ .number }}">0</div>
          <div class="homepage-stat-label">{{ .label }}</div>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ======================================== FEATURED ROUTES */}}
  {{ with .Params.featured_routes }}
  <section class="homepage-routes">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.routes_title }}</h2>
      <div class="homepage-routes-grid">
        {{ range . }}
        <a href="{{ .link }}" class="homepage-route-card fade-in-on-scroll">
          <div class="homepage-route-image">
            <img src="{{ .image }}" alt="{{ .title }}" loading="lazy">
            {{ if .badge }}<span class="homepage-route-badge">{{ .badge }}</span>{{ end }}
          </div>
          <div class="homepage-route-content">
            <h3>{{ .title }}</h3>
            <p class="homepage-route-meta">{{ .distance }} • {{ .elevation }}</p>
          </div>
        </a>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ======================================== TESTIMONIALS */}}
  {{ with .Params.testimonials }}
  <section class="homepage-testimonials">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.testimonials_title }}</h2>
      <div class="homepage-testimonials-grid">
        {{ range . }}
        <div class="homepage-testimonial-card fade-in-on-scroll">
          <div class="homepage-testimonial-stars">★★★★★</div>
          <p class="homepage-testimonial-text">"{{ .quote }}"</p>
          <div class="homepage-testimonial-author">
            <strong>{{ .name }}</strong>
            {{ if .location }}<span> • {{ .location }}</span>{{ end }}
          </div>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ======================================== FAQ ACCORDION */}}
  {{ with .Params.faq }}
  <section class="homepage-faq">
    <div class="container">
      <h2 class="homepage-section-title">{{ $.Params.faq_title }}</h2>
      <div class="homepage-faq-grid">
        {{ range . }}
        <details class="faq-item">
          <summary>{{ .question }}</summary>
          <div class="answer">{{ .answer | markdownify }}</div>
        </details>
        {{ end }}
      </div>
    </div>
  </section>
  {{ end }}

  {{/* ======================================== FINAL CTA BANNER */}}
  {{ with .Params.final_cta }}
  <section class="homepage-final-cta">
    <div class="container">
      <div class="homepage-final-cta-content">
        <h2>{{ .title }}</h2>
        <p>{{ .subtitle }}</p>
        <a href="{{ .button_url }}" class="homepage-cta-btn primary">{{ .button_text }}</a>
      </div>
    </div>
  </section>
  {{ end }}

  {{/* Scroll animation script */}}
  <script>
    const observerOptions = {threshold: 0.1, rootMargin: '0px 0px -50px 0px'};
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {if (entry.isIntersecting) entry.target.classList.add('visible');});
    }, observerOptions);
    document.querySelectorAll('.fade-in-on-scroll').forEach(el => observer.observe(el));

    const counters = document.querySelectorAll('.homepage-stat-number');
    const counterObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !entry.target.classList.contains('counted')) {
          const target = parseFloat(entry.target.dataset.target);
          const hasDecimal = entry.target.dataset.target.includes('.');
          const duration = 2000;
          const step = target / (duration / 16);
          let current = 0;
          const timer = setInterval(() => {
            current += step;
            if (current >= target) {
              entry.target.textContent = hasDecimal ? target.toFixed(1) : target.toLocaleString();
              clearInterval(timer);
              entry.target.classList.add('counted');
            } else {
              entry.target.textContent = hasDecimal ? current.toFixed(1) : Math.floor(current).toLocaleString();
            }
          }, 16);
        }
      });
    }, { threshold: 0.5 });
    counters.forEach(counter => counterObserver.observe(counter));
  </script>

{{ else }}
  {{/* Regular list page */}}
  <section>
    <div class="container content-wrap">
      <article class="prose content-prose">
        <h1>{{ .Title }}</h1>
        {{ with .Content }}{{ . }}{{ end }}

        {{ if .Pages }}
          <ul>
            {{ range .Pages }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
          </ul>
        {{ end }}
      </article>
    </div>
  </section>
{{ end }}
{{ end }}
